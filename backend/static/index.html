<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ìŠ¹ë¦¬ ë„ì‹œì§€ì—­ ë“œë¡  ìš´ìš© íŒë‹¨ í”„ë¡œê·¸ë¨</title>

    <script>
        window.onerror = function (msg, url, line, col, error) {
            var root = document.getElementById('root');
            if (root) {
                root.innerHTML = '<div style="color:white; padding:20px; text-align:center;">' +
                    '<h1>âš ï¸ í”„ë¡œê·¸ë¨ ì˜¤ë¥˜ ë°œìƒ</h1>' +
                    '<p>' + msg + '</p>' +
                    '<small>' + url + ':' + line + ':' + col + '</small>' +
                    '</div>';
            }
            return false;
        };
    </script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.osmbuildings.org/4.1.1/OSMBuildings.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: { extend: { colors: { bg: '#0f172a', surface: '#1e293b', card: 'rgba(30, 41, 59, 0.7)' } } }
        }
    </script>
    <style>
        body {
            background-color: #0f172a;
            color: #f1f5f9;
            font-family: 'Noto Sans KR', sans-serif;
        }

        .map-wrapper {
            position: relative;
            height: 500px;
            border-radius: 0.75rem;
            overflow: hidden;
            border: 1px solid #334155;
        }

        #map {
            height: 100%;
            width: 100%;
            z-index: 0;
        }

        .leaflet-control {
            z-index: 1000 !important;
        }

        .grid-card {
            background: rgba(30, 41, 59, 0.6);
            backdrop-filter: blur(8px);
            border: 1px solid rgba(148, 163, 184, 0.2);
            border-radius: 8px;
            padding: 10px;
            text-align: center;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: 90px;
            transition: all 0.2s;
        }

        .grid-card:hover {
            background: rgba(30, 41, 59, 0.9);
            border-color: rgba(96, 165, 250, 0.5);
        }

        .grid-label {
            font-size: 11px;
            color: #94a3b8;
            margin-bottom: 4px;
            font-weight: bold;
        }

        .grid-value {
            font-size: 18px;
            font-weight: 800;
            color: white;
        }

        .grid-sub {
            font-size: 10px;
            color: #64748b;
            margin-top: 2px;
        }

        /* 3D Control Panel */
        .ctrl-panel {
            background: #1e293b;
            border: 1px solid #475569;
            border-radius: 6px;
            overflow: hidden;
            margin-bottom: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        }

        .ctrl-btn {
            padding: 6px 10px;
            color: white;
            font-size: 12px;
            font-weight: bold;
            text-align: center;
            cursor: pointer;
            border-bottom: 1px solid #334155;
        }

        .ctrl-btn:last-child {
            border-bottom: none;
        }

        .ctrl-btn:hover {
            background: #334155;
        }

        .ctrl-row {
            display: flex;
        }

        .ctrl-half {
            width: 50%;
            border-right: 1px solid #334155;
        }

        .ctrl-half:last-child {
            border-right: none;
        }

        /* Feature Banner */
        .feature-banner {
            background: linear-gradient(135deg, #1e3a8a, #7c3aed);
            padding: 12px 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            animation: slideDown 0.3s ease-out;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-100%);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .feature-banner .banner-icon {
            font-size: 1.5em;
        }

        .feature-banner .banner-text {
            color: white;
            font-size: 0.95rem;
        }

        .feature-banner .banner-text strong {
            background: #22c55e;
            padding: 2px 8px;
            border-radius: 4px;
            margin-right: 8px;
            font-size: 0.85em;
        }

        .feature-banner .banner-close {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1rem;
            transition: background 0.2s;
        }

        .feature-banner .banner-close:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        /* Tab Navigation */
        .tab-navigation {
            display: flex;
            background: #1e293b;
            border-bottom: 1px solid #334155;
            padding: 0 20px;
        }

        .tab-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 15px 25px;
            background: transparent;
            border: none;
            color: #94a3b8;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.2s;
            position: relative;
        }

        .tab-btn:hover {
            background: rgba(59, 130, 246, 0.1);
            color: #f1f5f9;
        }

        .tab-btn.active {
            color: #3b82f6;
            border-bottom-color: #3b82f6;
            background: rgba(59, 130, 246, 0.1);
        }

        .tab-btn .tab-label {
            font-size: 1.1rem;
            font-weight: 600;
        }

        .tab-btn .tab-desc {
            font-size: 0.75rem;
            margin-top: 4px;
            opacity: 0.8;
        }

        .tab-btn .tab-new-badge {
            position: absolute;
            top: 8px;
            right: 8px;
            background: linear-gradient(135deg, #22c55e, #16a34a);
            color: white;
            font-size: 0.6rem;
            font-weight: 700;
            padding: 2px 6px;
            border-radius: 4px;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
                transform: scale(1);
            }

            50% {
                opacity: 0.8;
                transform: scale(1.05);
            }
        }

        /* Corridor Simulation Styles */
        .corridor-content {
            display: flex;
            gap: 20px;
            padding: 20px;
            max-width: 1600px;
            margin: 0 auto;
        }

        .corridor-map-section {
            flex: 1;
            background: rgba(30, 41, 59, 0.6);
            border-radius: 12px;
            padding: 20px;
            border: 1px solid #334155;
        }

        .corridor-panel-section {
            width: 400px;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .point-selection {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 15px 0;
        }

        .point-btn {
            flex: 1;
            padding: 12px 15px;
            background: #1e293b;
            border: 2px solid #475569;
            border-radius: 8px;
            color: #94a3b8;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.9em;
        }

        .point-btn:hover {
            background: #334155;
        }

        .point-btn.active {
            border-color: #3b82f6;
            background: rgba(59, 130, 246, 0.2);
            color: #60a5fa;
        }

        .point-btn.selected {
            border-color: #22c55e;
            color: #4ade80;
        }

        .point-arrow {
            font-size: 1.5em;
            color: #64748b;
        }

        .selection-hint {
            background: rgba(59, 130, 246, 0.2);
            border: 1px solid #3b82f6;
            border-radius: 8px;
            padding: 10px 15px;
            margin-bottom: 15px;
            color: #60a5fa;
            text-align: center;
            animation: pulse 1.5s infinite;
        }

        .settings-panel {
            background: rgba(30, 41, 59, 0.6);
            border-radius: 12px;
            padding: 20px;
            border: 1px solid #334155;
        }

        .setting-row {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 12px;
        }

        .setting-row label {
            width: 100px;
            color: #94a3b8;
        }

        .setting-row input,
        .setting-row select {
            flex: 1;
            padding: 8px 12px;
            background: #1e293b;
            border: 1px solid #475569;
            border-radius: 6px;
            color: white;
        }

        .analyze-btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #3b82f6, #8b5cf6);
            border: none;
            border-radius: 8px;
            color: white;
            font-size: 1.1em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
        }

        .analyze-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(59, 130, 246, 0.4);
        }

        .analyze-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .overall-result {
            border-radius: 12px;
            padding: 20px;
            border: 2px solid;
        }

        .result-value {
            font-size: 2em;
            font-weight: bold;
            margin-bottom: 15px;
        }

        .result-details {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            color: #94a3b8;
            font-size: 0.9em;
        }

        .segments-panel {
            background: rgba(30, 41, 59, 0.6);
            border-radius: 12px;
            padding: 20px;
            border: 1px solid #334155;
        }

        .segment-item {
            background: #1e293b;
            border-radius: 8px;
            padding: 12px;
            border-left: 4px solid;
            margin-bottom: 10px;
        }

        .corridor-bar-container {
            display: flex;
            height: 30px;
            border-radius: 6px;
            overflow: hidden;
        }

        .bar-segment {
            transition: opacity 0.2s;
        }

        .bar-labels {
            display: flex;
            justify-content: space-between;
            margin-top: 8px;
            color: #64748b;
            font-size: 0.85em;
        }

        @media (max-width: 900px) {
            .corridor-content {
                flex-direction: column;
            }

            .corridor-panel-section {
                width: 100%;
            }
        }
    </style>
</head>

<body>
    <div id="root">
        <div style="text-align:center; padding-top:100px; color:#64748b;">ë¡œë”© ì¤‘...</div>
    </div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        const DRONE_MODELS = [
            { id: "DJI Mini 3 Pro", name: "DJI Mini 3 Pro (ì†Œí˜•)", desc: "í•œê³„ 10.7m/s" },
            { id: "DJI Mavic 3", name: "DJI Mavic 3 (ì¤€ì „ë¬¸ê°€ìš©)", desc: "í•œê³„ 12m/s" },
            { id: "DJI Matrice 300 RTK", name: "DJI Matrice 300 (ì‚°ì—…ìš©)", desc: "í•œê³„ 15m/s" },
            { id: "DJI Inspire 3", name: "DJI Inspire 3 (ì´¬ì˜ìš©)", desc: "í•œê³„ 14m/s" },
            { id: "Custom (Generic)", name: "ê¸°ë³¸ ì„¤ì • (Custom)", desc: "í•œê³„ 10m/s" }
        ];

        function getWeatherIcon(code) {
            if (code === 0) return "â˜€ï¸";
            if (code <= 3) return "â˜ï¸";
            if (code >= 95) return "â›ˆï¸";
            if (code >= 71) return "â„ï¸";
            if (code >= 51) return "ğŸŒ§ï¸";
            if (code >= 45) return "ğŸŒ«ï¸";
            return "ğŸŒ¤ï¸";
        }

        const MapComponent = ({ lat, lon, onLocationSelect }) => {
            const mapRef = useRef(null);
            const markerRef = useRef(null);
            const osmbRef = useRef(null);
            const noFlyLayerRef = useRef(null);
            const rotRef = useRef(0);
            const tiltRef = useRef(45);

            // Overpass API: ê±´ë¬¼ ìƒì„¸ ì •ë³´ ì¡°íšŒ
            const fetchBuildingDetails = async (lat, lon) => {
                const query = `[out:json];(way(around:50,${lat},${lon})["building"];);out tags;`;
                const url = `https://overpass-api.de/api/interpreter?data=${encodeURIComponent(query)}`;
                try {
                    const res = await fetch(url);
                    const data = await res.json();
                    if (data.elements && data.elements.length > 0) {
                        const tags = data.elements[0].tags;
                        return {
                            name: tags.name || tags['name:ko'] || tags['name:en'] || null,
                            levels: tags['building:levels'] ? parseInt(tags['building:levels']) : null,
                            height: tags.height ? parseFloat(tags.height) : null
                        };
                    }
                } catch (e) { console.warn('Overpass API Error:', e); }
                return null;
            };

            // 3D ì¡°ì‘
            const adjust = (type) => {
                if (!osmbRef.current) return;
                if (type === 'rl') rotRef.current -= 15;
                if (type === 'rr') rotRef.current += 15;
                if (type === 'tu') tiltRef.current = Math.min(tiltRef.current + 10, 60);
                if (type === 'td') tiltRef.current = Math.max(tiltRef.current - 10, 0);
                osmbRef.current.setRotation(rotRef.current);
                osmbRef.current.setTilt(tiltRef.current);
            };

            // ë¹„í–‰ê¸ˆì§€êµ¬ì—­ í† ê¸€
            const toggleNoFlyZones = () => {
                if (!mapRef.current || !noFlyLayerRef.current) return;
                if (mapRef.current.hasLayer(noFlyLayerRef.current)) {
                    mapRef.current.removeLayer(noFlyLayerRef.current);
                } else {
                    mapRef.current.addLayer(noFlyLayerRef.current);
                }
            };

            useEffect(() => {
                if (mapRef.current) return;

                const m = L.map('map', {
                    center: [lat, lon], zoom: 16, zoomControl: false,
                    attributionControl: false
                });
                mapRef.current = m;

                L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                    maxZoom: 19
                }).addTo(m);

                markerRef.current = L.marker([lat, lon]).addTo(m);

                // ë¹„í–‰ê¸ˆì§€êµ¬ì—­ ë ˆì´ì–´ ë¡œë“œ
                fetch('/static/no_fly_zones.json')
                    .then(r => r.json())
                    .then(data => {
                        const layerGroup = L.layerGroup();
                        data.features.forEach(feature => {
                            const coords = feature.geometry.coordinates;
                            const props = feature.properties;
                            const circle = L.circle([coords[1], coords[0]], {
                                radius: props.radius_km * 1000,
                                color: 'red',
                                fillColor: '#ff0000',
                                fillOpacity: 0.15,
                                weight: 2
                            });
                            circle.bindPopup(`<b>${props.name}</b><br>${props.restriction}<br><small>${props.authority}</small>`);
                            layerGroup.addLayer(circle);
                        });
                        noFlyLayerRef.current = layerGroup;
                        // ì´ˆê¸°ì—ëŠ” í‘œì‹œí•˜ì§€ ì•ŠìŒ (ì‚¬ìš©ìê°€ í† ê¸€ë¡œ ì¼œì•¼ í•¨)
                    })
                    .catch(e => console.warn('No-fly zones load error:', e));

                // ì¤‘ìš”: ë§µ í´ë¦­ ì‹œ ì´ë²¤íŠ¸ ì „íŒŒ + Overpass API ì¡°íšŒ
                m.on('click', async (e) => {
                    console.log('Map Clicked:', e.latlng);
                    const overpassData = await fetchBuildingDetails(e.latlng.lat, e.latlng.lng);
                    onLocationSelect(e.latlng.lat, e.latlng.lng, overpassData);
                });

                // 3D Buildings
                try {
                    const osmb = new OSMBuildings(m).load('https://{s}.data.osmbuildings.org/0.2/59fcc2e8/tile/{z}/{x}/{y}.json');
                    osmbRef.current = osmb;

                    // 3D ê°ì²´ í´ë¦­ ì‹œ ì´ë²¤íŠ¸ ì „íŒŒ ë° ë©”íƒ€ë°ì´í„° ì¶”ì¶œ + Overpass API ë³´ê°•
                    osmb.click(async (e) => {
                        console.log('OSMB Clicked:', e);
                        const props = (e.feature && e.feature.properties) || {};
                        // Overpassë¡œ ì¶”ê°€ ì •ë³´ ì¡°íšŒ
                        const overpassData = await fetchBuildingDetails(e.lat, e.lon);
                        const mergedData = Object.assign({}, props, overpassData || {});
                        onLocationSelect(e.lat, e.lon, mergedData);
                    });
                } catch (e) { console.warn("OSMB Load Error", e); }

                // Controls
                const Ctrl = L.Control.extend({
                    onAdd: () => {
                        const d = L.DomUtil.create('div');

                        const bg1 = L.DomUtil.create('div', 'ctrl-panel', d);
                        const b1 = L.DomUtil.create('div', 'ctrl-btn', bg1);
                        b1.innerHTML = 'ğŸ‘€ ë¡œë“œë·°';
                        b1.onclick = (e) => {
                            e.preventDefault(); e.stopPropagation();
                            const c = mapRef.current.getCenter();
                            window.open('https://www.google.com/maps/@?api=1&map_action=pano&viewpoint=' + c.lat + ',' + c.lng, '_blank');
                        };

                        const bg2 = L.DomUtil.create('div', 'ctrl-panel', d);
                        const r1 = L.DomUtil.create('div', 'ctrl-row', bg2);
                        const bt1 = L.DomUtil.create('div', 'ctrl-btn ctrl-half', r1);
                        bt1.innerHTML = 'â†º ì¢Œ'; bt1.onclick = (e) => { e.stopPropagation(); adjust('rl') };
                        const bt2 = L.DomUtil.create('div', 'ctrl-btn ctrl-half', r1);
                        bt2.innerHTML = 'ìš° â†»'; bt2.onclick = (e) => { e.stopPropagation(); adjust('rr') };

                        const r2 = L.DomUtil.create('div', 'ctrl-row', bg2);
                        const bt3 = L.DomUtil.create('div', 'ctrl-btn ctrl-half', r2);
                        bt3.innerHTML = 'â¬†ï¸ ê°ë„'; bt3.onclick = (e) => { e.stopPropagation(); adjust('tu') };
                        const bt4 = L.DomUtil.create('div', 'ctrl-btn ctrl-half', r2);
                        bt4.innerHTML = 'â¬‡ï¸ ê°ë„'; bt4.onclick = (e) => { e.stopPropagation(); adjust('td') };

                        const bg3 = L.DomUtil.create('div', 'ctrl-panel', d);
                        const nfz = L.DomUtil.create('div', 'ctrl-btn', bg3);
                        nfz.innerHTML = 'ğŸš« ê¸ˆì§€êµ¬ì—­';
                        nfz.style.fontSize = '11px';
                        nfz.onclick = (e) => { e.stopPropagation(); toggleNoFlyZones(); };

                        return d;
                    }
                });
                new Ctrl({ position: 'topleft' }).addTo(m);

            }, []);

            useEffect(() => {
                if (!mapRef.current || !markerRef.current) return;
                markerRef.current.setLatLng([lat, lon]);
                // ì§€ë„ ì¤‘ì‹¬ ì´ë™
                mapRef.current.setView([lat, lon], mapRef.current.getZoom(), { animate: true });
            }, [lat, lon]);

            return <div className="map-wrapper shadow-2xl"><div id="map"></div></div>;
        };

        function App() {
            const [loc, setLoc] = useState({ lat: 37.5796, lon: 126.9631 });
            const [w, setW] = useState(null);
            const [evalRes, setEvalRes] = useState(null);
            const [loading, setLoading] = useState(false);
            const [bldg, setBldg] = useState(null);
            const [addr, setAddr] = useState("");

            const [form, setForm] = useState({
                building_height: 25, street_width: 15, wind_alignment: 'ì§ê°',
                mission_altitude: 30, no_fly_zone: false, crowd_area: false,
                gps_locked: 12, glonass_locked: 6, drone_model: "DJI Mavic 3"
            });

            // State for loading weather specifically
            const [weatherLoading, setWeatherLoading] = useState(false);

            // Tab & Banner state
            const [activeTab, setActiveTab] = useState('flight');
            const [showBanner, setShowBanner] = useState(true);

            // Corridor simulation state
            const [pointA, setPointA] = useState(null);
            const [pointB, setPointB] = useState(null);
            const [selectingPoint, setSelectingPoint] = useState(null);
            const [corridorAnalysis, setCorridorAnalysis] = useState(null);
            const [corridorSettings, setCorridorSettings] = useState({ altitude: 50, segmentCount: 5 });

            // ì•ˆì „í•œ ë¡œì§ ì²˜ë¦¬ (osmDataëŠ” Overpass API ê²°ê³¼ í¬í•¨)
            const onSelect = (lat, lon, osmData) => {
                setLoc({ lat, lon });
                setWeatherLoading(true); // ë¡œë”© ì‹œì‘

                // 1. Weather
                fetch('/api/weather?lat=' + lat + '&lon=' + lon)
                    .then(r => r.json())
                    .then(d => {
                        setW(d.weather);
                        setWeatherLoading(false); // ë¡œë”© ì™„ë£Œ
                    })
                    .catch(e => {
                        console.error(e);
                        setWeatherLoading(false);
                    });

                // 2. Building (Overpass + Backend ì¡°í•©)
                const fetchBuilding = fetch('/api/building-height?lat=' + lat + '&lon=' + lon).then(r => r.json());
                fetchBuilding.then(d => {
                    let finalBldg = d || {};

                    // Overpass API ë°ì´í„° ìš°ì„  ì ìš©
                    if (osmData) {
                        const name = osmData.name;
                        const levels = osmData.levels;
                        const height = osmData.height || (levels ? levels * 3.5 : null);

                        if (name) finalBldg.name = name;
                        if (levels) {
                            finalBldg.estimated_floors = levels;
                            finalBldg.source = "OSM ì‹¤ì¸¡";
                        }
                        if (height) {
                            finalBldg.estimated_height_m = height;
                            finalBldg.source = "OSM ì‹¤ì¸¡";
                        }

                        // OSM ì‹¤ì¸¡ ë°ì´í„°ê°€ ìˆìœ¼ë©´ ìš©ë„ì§€ì—­ í‘œì‹œ ë³€ê²½
                        if (levels || height) {
                            finalBldg.zoning_type = "OSM ì‹¤ì¸¡ ë°ì´í„°";
                        }
                    }

                    setBldg(finalBldg);

                    // í¼ì— ê±´ë¬¼ ë†’ì´ ìë™ ì…ë ¥
                    if (finalBldg.estimated_height_m) {
                        setForm(p => Object.assign({}, p, { building_height: finalBldg.estimated_height_m }));
                    }

                    // 3. Address (Overpass ê±´ë¬¼ëª… ìš°ì„ , ì—†ìœ¼ë©´ Nominatim)
                    if (osmData && osmData.name) {
                        setAddr('ğŸ¢ ' + osmData.name);
                    } else {
                        setAddr("ìœ„ì¹˜ í™•ì¸ ì¤‘...");
                        fetch('https://nominatim.openstreetmap.org/reverse?format=json&lat=' + lat + '&lon=' + lon + '&zoom=18&addressdetails=1', { headers: { 'User-Agent': 'UAV-Dash' } })
                            .then(r => r.json())
                            .then(d => {
                                const a = d.address;
                                var label = 'ìœ„ì¹˜ í™•ì¸ë¨';
                                if (a) {
                                    const b = a.building || a.apartment || a.office;
                                    if (b) label = 'ğŸ¢ ' + b;
                                    else label = 'ğŸ“ ' + (a.road || a.city || 'ìœ„ì¹˜ í™•ì¸ë¨');
                                }
                                setAddr(label);
                            })
                            .catch(() => setAddr("ì£¼ì†Œ ì •ë³´ ì—†ìŒ"));
                    }
                }).catch(e => console.error(e));
            };

            const runEval = async () => {
                setLoading(true);
                try {
                    const payload = Object.assign({ latitude: loc.lat, longitude: loc.lon }, form);
                    const res = await fetch('/api/evaluate', {
                        method: 'POST', headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    const d = await res.json();
                    setEvalRes(d);
                } catch (e) { alert("Error: " + e); }
                finally { setLoading(false); }
            };

            useEffect(() => { onSelect(loc.lat, loc.lon); }, []);

            const getStatusColor = (s) => {
                if (s === 'GO') return 'bg-green-900/40 text-green-400 border-green-500';
                if (s === 'RESTRICT') return 'bg-yellow-900/40 text-yellow-500 border-yellow-500';
                return 'bg-red-900/40 text-red-500 border-red-500';
            };

            // Drone Desc Helper
            const currentDrone = DRONE_MODELS.find(function (m) { return m.id === form.drone_model }) || {};
            const droneDesc = currentDrone.desc || form.drone_model;

            return (
                <div className="container mx-auto p-4 max-w-7xl animate-fade-in pb-20">
                    <header className="mb-6 flex justify-between items-center bg-slate-800 p-6 rounded-xl shadow-lg border-b-4 border-blue-600">
                        <div>
                            <h1 className="text-2xl font-black text-white">ğŸš ìŠ¹ë¦¬ ë„ì‹œì§€ì—­ ë“œë¡  ìš´ìš© íŒë‹¨</h1>
                            <p className="text-blue-300 text-sm mt-1">UAV Urban Operations Dashboard</p>
                        </div>
                        <div className="text-right">
                            <span className="bg-blue-900/50 text-blue-200 px-3 py-1 rounded text-sm font-bold border border-blue-500/30">
                                {droneDesc}
                            </span>
                        </div>
                    </header>

                    {/* ğŸ‰ NEW Feature Banner */}
                    {showBanner && (
                        <div className="feature-banner mb-4 rounded-xl">
                            <span className="banner-icon">ğŸ›¤ï¸</span>
                            <span className="banner-text">
                                <strong>NEW!</strong> ë“œë¡  íšŒë‘ ì‹œë®¬ë ˆì´ì…˜ ê¸°ëŠ¥ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤! Aâ†’B ê²½ë¡œì˜ ìœ„í—˜ë„ë¥¼ ë¶„ì„í•´ë³´ì„¸ìš”.
                            </span>
                            <button className="banner-close" onClick={() => setShowBanner(false)}>âœ•</button>
                        </div>
                    )}

                    {/* Tab Navigation */}
                    <nav className="tab-navigation mb-6 rounded-xl overflow-hidden">
                        <button
                            className={`tab-btn ${activeTab === 'flight' ? 'active' : ''}`}
                            onClick={() => setActiveTab('flight')}
                        >
                            <span className="tab-label">ğŸš¦ ë¹„í–‰ íŒì •</span>
                            <span className="tab-desc">4ì¤‘ ê²Œì´íŠ¸ ì‹œìŠ¤í…œ</span>
                        </button>
                        <button
                            className={`tab-btn ${activeTab === 'corridor' ? 'active' : ''}`}
                            onClick={() => setActiveTab('corridor')}
                        >
                            <span className="tab-label">ğŸ›¤ï¸ íšŒë‘ ì‹œë®¬ë ˆì´ì…˜</span>
                            <span className="tab-new-badge">NEW</span>
                            <span className="tab-desc">ê²½ë¡œ ìœ„í—˜ë„ ë¶„ì„</span>
                        </button>
                    </nav>

                    {/* === FLIGHT TAB (ê¸°ì¡´ ì½˜í…ì¸ ) === */}
                    {activeTab === 'flight' && (
                        <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            {/* LEFT COLUMN: Map & Controls */}
                            <div className="space-y-4">
                                {/* MAP */}
                                <div className="relative">
                                    <MapComponent lat={loc.lat} lon={loc.lon} onLocationSelect={onSelect} />
                                    <div className="absolute bottom-4 left-4 bg-slate-900/90 backdrop-blur-md p-3 rounded-lg border border-slate-600 z-[999] shadow-2xl min-w-[240px] transition-all">
                                        <div className="font-bold text-sm text-white flex items-center gap-2 mb-1">
                                            <span>ğŸ“</span> {addr || 'ì§€ë„ì—ì„œ ìœ„ì¹˜ë¥¼ ì„ íƒí•˜ì„¸ìš”'}
                                        </div>
                                        {bldg ? (
                                            <div className="text-xs text-gray-400 space-y-1 border-t border-gray-700 pt-2 mt-2">
                                                <div className="flex justify-between items-center">
                                                    <span>ğŸ¢ ê±´ë¬¼ ê·œëª¨</span>
                                                    <span className="text-white font-bold text-sm">{bldg.estimated_floors}ì¸µ <span className="text-gray-500 font-normal">({bldg.estimated_height_m}m)</span></span>
                                                </div>
                                                <div className="flex justify-between items-center">
                                                    <span>ğŸ—ï¸ ìš©ë„ì§€ì—­</span>
                                                    <span className="text-blue-400 font-medium">{bldg.zoning_type}</span>
                                                </div>
                                                <div className="flex justify-between items-center">
                                                    <span>ğŸ“Š ìš©ì /ê±´í</span>
                                                    <span className="text-gray-300">{bldg.far_percent}% / {bldg.bcr_percent}%</span>
                                                </div>
                                            </div>
                                        ) : (
                                            <div className="text-xs text-gray-500 mt-1 pl-6">í´ë¦­í•˜ì—¬ ê±´ë¬¼ ì •ë³´ ë¶„ì„...</div>
                                        )}
                                    </div>
                                </div>

                                {/* DRONE & ENV INPUTS */}
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div className="bg-surface p-4 rounded-xl border border-gray-700">
                                        <h3 className="text-xs font-bold text-gray-400 mb-2">ìš´ìš© ê¸°ì²´</h3>
                                        <select className="w-full bg-slate-900 border border-slate-600 p-2 rounded text-white font-bold text-sm outline-none focus:border-blue-500"
                                            value={form.drone_model} onChange={e => setForm({ ...form, drone_model: e.target.value })}>
                                            {DRONE_MODELS.map(m => <option key={m.id} value={m.id}>{m.name}</option>)}
                                        </select>
                                    </div>
                                    <div className="bg-surface p-4 rounded-xl border border-gray-700">
                                        <h3 className="text-xs font-bold text-gray-400 mb-2">í˜„ì¥ ë³€ìˆ˜</h3>
                                        <div className="flex gap-2">
                                            <input type="number" placeholder="ê±´ë¬¼H(m)" className="w-1/2 bg-slate-900 border border-slate-600 p-2 rounded text-white text-sm"
                                                value={form.building_height} onChange={e => setForm({ ...form, building_height: parseFloat(e.target.value) })} />
                                            <input type="number" placeholder="ë„ë¡œW(m)" className="w-1/2 bg-slate-900 border border-slate-600 p-2 rounded text-white text-sm"
                                                value={form.street_width} onChange={e => setForm({ ...form, street_width: parseFloat(e.target.value) })} />
                                        </div>
                                    </div>
                                </div>

                                <button onClick={runEval} disabled={loading}
                                    className="w-full py-4 rounded-xl font-black text-lg text-white bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-500 hover:to-indigo-500 shadow-lg transform active:scale-[0.98] transition-all">
                                    {loading ? 'ë°ì´í„° ì •ë°€ ë¶„ì„ ì¤‘...' : 'ğŸš€ ë¹„í–‰ ê°€ëŠ¥ ì—¬ë¶€ íŒì • (EVALUATE)'}
                                </button>
                            </div>

                            {/* RIGHT COLUMN: Weather & Results */}
                            <div className="space-y-4">
                                {/* WEATHER GRID (UAV Forecast Style) */}
                                <div className="bg-slate-800 p-5 rounded-xl border border-gray-700 shadow-lg relative">
                                    <h3 className="font-bold text-white mb-4 flex items-center justify-between">
                                        <span className="flex items-center gap-2">ğŸŒ¤ï¸ ì‹¤ì‹œê°„ ê¸°ìƒ ìƒíƒœ <span className="text-xs font-normal text-gray-400">(Open-Meteo ê¸°ë°˜)</span></span>
                                        <span className="text-[10px] bg-slate-900 px-2 py-1 rounded text-gray-400 font-mono">
                                            {Number(loc.lat).toFixed(4)}, {Number(loc.lon).toFixed(4)}
                                        </span>
                                    </h3>

                                    {weatherLoading && (
                                        <div className="absolute inset-0 bg-slate-900/60 backdrop-blur-sm z-10 flex items-center justify-center rounded-xl">
                                            <div className="text-blue-400 font-bold animate-pulse">ë°ì´í„° ê°±ì‹  ì¤‘...</div>
                                        </div>
                                    )}

                                    {w ? (
                                        <div className={`grid grid-cols-4 gap-2 transition-opacity ${weatherLoading ? 'opacity-50' : 'opacity-100'}`}>
                                            {/* Row 1 */}
                                            <div className="grid-card col-span-2 bg-gradient-to-br from-blue-900/40 to-slate-900/40">
                                                <div className="text-4xl mb-1">{getWeatherIcon(w.weather_code)}</div>
                                                <div className="text-white font-bold text-lg">
                                                    {w.weather_code === 0 ? "ë§‘ìŒ" : w.weather_code <= 3 ? "êµ¬ë¦„" : w.weather_code >= 51 ? "ë¹„/ëˆˆ" : "íë¦¼"}
                                                </div>
                                            </div>
                                            <div className="grid-card">
                                                <div className="grid-label">ì¼ì¶œ/ì¼ëª°</div>
                                                <div className="grid-value text-base text-yellow-400">{w.sunrise}</div>
                                                <div className="grid-sub">{w.sunset}</div>
                                            </div>
                                            <div className="grid-card">
                                                <div className="grid-label">ì˜¨ë„</div>
                                                <div className="grid-value text-orange-400">{Math.round(w.temperature)}Â°C</div>
                                                <div className="grid-sub">ì´ìŠ¬ì  {Math.round(w.dew_point)}Â°C</div>
                                            </div>

                                            {/* Row 2 */}
                                            <div className="grid-card">
                                                <div className="grid-label">í’ì†</div>
                                                <div className="grid-value text-blue-400">{Number(w.wind_speed).toFixed(1)}</div>
                                                <div className="grid-sub">m/s</div>
                                            </div>
                                            <div className="grid-card">
                                                <div className="grid-label">ëŒí’</div>
                                                <div className="grid-value text-yellow-500">{Number(w.gust_speed).toFixed(1)}</div>
                                                <div className="grid-sub">m/s</div>
                                            </div>
                                            <div className="grid-card">
                                                <div className="grid-label">í’í–¥</div>
                                                <div className="text-2xl" style={{ transform: 'rotate(' + w.wind_direction + 'deg)' }}>â¬†ï¸</div>
                                                <div className="grid-sub">{w.wind_direction}Â°</div>
                                            </div>
                                            <div className="grid-card">
                                                <div className="grid-label">ê°•ìˆ˜í™•ë¥ </div>
                                                <div className="grid-value text-blue-300">{w.precipitation_prob}%</div>
                                                <div className="grid-sub">ìŠµë„ {w.humidity}%</div>
                                            </div>

                                            {/* Row 3 */}
                                            <div className="grid-card">
                                                <div className="grid-label">êµ¬ë¦„ì–‘</div>
                                                <div className="grid-value text-gray-300">{w.cloud_cover}%</div>
                                                <div className="grid-sub">Ceiling Info</div>
                                            </div>
                                            <div className="grid-card">
                                                <div className="grid-label">ì‹œì •</div>
                                                <div className="grid-value text-green-400">{Number(w.visibility).toFixed(1)}</div>
                                                <div className="grid-sub">km</div>
                                            </div>
                                            <div className="grid-card">
                                                <div className="grid-label">ìœ„ì„±(GPS)</div>
                                                <div className="grid-value text-purple-400">{form.gps_locked}</div>
                                                <div className="grid-sub">GLO {form.glonass_locked}</div>
                                            </div>
                                            <div className="grid-card">
                                                <div className="grid-label">Kp ì§€ìˆ˜</div>
                                                <div className="grid-value text-red-400">{w.kp_index}</div>
                                                <div className="grid-sub">ì „íŒŒë°©í•´</div>
                                            </div>
                                        </div>
                                    ) : (<div className="text-center py-10 text-gray-500">ë°ì´í„° ë¡œë”© ì¤‘...</div>)}
                                </div>

                                {/* EVALUATION RESULTS */}
                                {evalRes && (
                                    <div className="space-y-4 animate-fade-in">
                                        <div className={`p-6 rounded-2xl border-4 text-center shadow-2xl ${getStatusColor(evalRes.final_judgment)}`}>
                                            <div className="text-sm font-bold opacity-70 mb-1">FINAL DECISION</div>
                                            <div className="text-5xl font-black tracking-tighter">{evalRes.final_judgment}</div>
                                        </div>

                                        <div className="bg-surface p-5 rounded-xl border border-gray-700">
                                            <h3 className="font-bold text-white mb-3">ğŸ“ ìƒì„¸ íŒì • ì‚¬ìœ ì„œ</h3>
                                            <div className="space-y-2">
                                                {evalRes.gates.map((g, i) => (
                                                    <div key={i} className="p-3 bg-slate-900/50 rounded border border-slate-700/50 flex flex-col gap-1">
                                                        <div className="flex justify-between items-center">
                                                            <span className="font-bold text-gray-300 text-sm">{g.gate}</span>
                                                            <span className={`text-xs font-bold px-2 py-0.5 rounded ${getStatusColor(g.status).replace('border-green-500', 'border-transparent')}`}>
                                                                {g.status}
                                                            </span>
                                                        </div>
                                                        <div className="text-white text-sm pl-2 border-l-2 border-slate-600">
                                                            {g.reason}
                                                        </div>
                                                    </div>
                                                ))}
                                            </div>
                                        </div>

                                        <div className="bg-blue-900/20 p-3 rounded text-xs text-gray-400 grid grid-cols-2 gap-2">
                                            <div>EWS(ë¹Œë”©í’): <b className="text-white">{evalRes.ews}m/s</b></div>
                                            <div>Fcanyon: <b className="text-white">x{evalRes.urban_factors.Fcanyon}</b></div>
                                        </div>
                                    </div>
                                )}
                            </div>
                        </div>
                    </div>
            )
        }

        {/* === CORRIDOR TAB === */ }
        {
            activeTab === 'corridor' && (
                <div className="corridor-content">
                    <div className="corridor-map-section">
                        <h3 className="text-white font-bold mb-2">ğŸ—ºï¸ ê²½ë¡œ ì„¤ì •</h3>
                        <p className="text-gray-400 text-sm mb-4">ì§€ë„ì—ì„œ ì¶œë°œì (A)ê³¼ ë„ì°©ì (B)ì„ ì„ íƒí•˜ì„¸ìš”</p>

                        <div className="point-selection">
                            <button
                                className={`point-btn ${selectingPoint === 'A' ? 'active' : ''} ${pointA ? 'selected' : ''}`}
                                onClick={() => setSelectingPoint('A')}
                            >
                                ğŸ…°ï¸ ì¶œë°œì  {pointA ? `(${pointA.lat.toFixed(4)}, ${pointA.lon.toFixed(4)})` : '(ë¯¸ì„ íƒ)'}
                            </button>
                            <span className="point-arrow">â†’</span>
                            <button
                                className={`point-btn ${selectingPoint === 'B' ? 'active' : ''} ${pointB ? 'selected' : ''}`}
                                onClick={() => setSelectingPoint('B')}
                            >
                                ğŸ…±ï¸ ë„ì°©ì  {pointB ? `(${pointB.lat.toFixed(4)}, ${pointB.lon.toFixed(4)})` : '(ë¯¸ì„ íƒ)'}
                            </button>
                        </div>

                        {selectingPoint && (
                            <div className="selection-hint">
                                ğŸ‘† ì§€ë„ë¥¼ í´ë¦­í•˜ì—¬ {selectingPoint === 'A' ? 'ì¶œë°œì ' : 'ë„ì°©ì '}ì„ ì„ íƒí•˜ì„¸ìš”
                            </div>
                        )}

                        <div className="map-wrapper shadow-2xl" style={{ height: '400px' }}>
                            <MapComponent
                                lat={pointA ? pointA.lat : loc.lat}
                                lon={pointA ? pointA.lon : loc.lon}
                                onLocationSelect={(lat, lon) => {
                                    if (selectingPoint === 'A') {
                                        setPointA({ lat, lon });
                                        setSelectingPoint(null);
                                        setCorridorAnalysis(null);
                                    } else if (selectingPoint === 'B') {
                                        setPointB({ lat, lon });
                                        setSelectingPoint(null);
                                        setCorridorAnalysis(null);
                                    }
                                }}
                            />
                        </div>
                    </div>

                    <div className="corridor-panel-section">
                        <div className="settings-panel">
                            <h3 className="text-white font-bold mb-4">âš™ï¸ ë¹„í–‰ ì„¤ì •</h3>
                            <div className="setting-row">
                                <label>ë¹„í–‰ ê³ ë„:</label>
                                <input type="number" value={corridorSettings.altitude}
                                    onChange={e => setCorridorSettings({ ...corridorSettings, altitude: parseInt(e.target.value) })} />
                                <span className="text-gray-400">m</span>
                            </div>
                            <div className="setting-row">
                                <label>ë¶„ì„ êµ¬ê°„:</label>
                                <select value={corridorSettings.segmentCount}
                                    onChange={e => setCorridorSettings({ ...corridorSettings, segmentCount: parseInt(e.target.value) })}>
                                    <option value={3}>3 êµ¬ê°„</option>
                                    <option value={5}>5 êµ¬ê°„</option>
                                    <option value={10}>10 êµ¬ê°„</option>
                                </select>
                            </div>
                            <button
                                className="analyze-btn"
                                disabled={!pointA || !pointB}
                                onClick={() => {
                                    // ëª¨ì˜ ë¶„ì„ (ë°±ì—”ë“œ API ë¯¸êµ¬í˜„ ëŒ€ë¹„)
                                    const segments = [];
                                    for (let i = 0; i < corridorSettings.segmentCount; i++) {
                                        const riskLevel = Math.random();
                                        let status = 'GO';
                                        if (riskLevel > 0.7) status = 'NO-GO';
                                        else if (riskLevel > 0.4) status = 'RESTRICT';
                                        segments.push({
                                            id: i + 1, status,
                                            wind: (Math.random() * 8 + 2).toFixed(1),
                                            building: Math.floor(Math.random() * 30 + 10)
                                        });
                                    }
                                    const goCount = segments.filter(s => s.status === 'GO').length;
                                    const nogoCount = segments.filter(s => s.status === 'NO-GO').length;
                                    let overall = 'GO';
                                    if (nogoCount > 0) overall = 'NO-GO';
                                    else if (goCount < corridorSettings.segmentCount / 2) overall = 'RESTRICT';

                                    const distance = Math.sqrt(
                                        Math.pow((pointB.lat - pointA.lat) * 111000, 2) +
                                        Math.pow((pointB.lon - pointA.lon) * 88000, 2)
                                    );
                                    setCorridorAnalysis({
                                        overall, segments,
                                        distance: Math.round(distance),
                                        time: Math.round(distance / 10 / 60 * 10) / 10
                                    });
                                }}
                            >
                                {(!pointA || !pointB) ? 'ğŸ“ ì¶œë°œ/ë„ì°©ì ì„ ì„ íƒí•˜ì„¸ìš”' : 'ğŸš€ íšŒë‘ ë¶„ì„ ì‹œì‘'}
                            </button>
                        </div>

                        {corridorAnalysis && (
                            <>
                                <div className="overall-result" style={{
                                    backgroundColor: corridorAnalysis.overall === 'GO' ? 'rgba(34,197,94,0.2)' :
                                        corridorAnalysis.overall === 'RESTRICT' ? 'rgba(234,179,8,0.2)' : 'rgba(239,68,68,0.2)',
                                    borderColor: corridorAnalysis.overall === 'GO' ? '#22c55e' :
                                        corridorAnalysis.overall === 'RESTRICT' ? '#eab308' : '#ef4444'
                                }}>
                                    <h3 className="text-white text-sm font-bold mb-2">ì¢…í•© íŒì •</h3>
                                    <div className="result-value" style={{
                                        color: corridorAnalysis.overall === 'GO' ? '#22c55e' :
                                            corridorAnalysis.overall === 'RESTRICT' ? '#eab308' : '#ef4444'
                                    }}>
                                        {corridorAnalysis.overall === 'GO' ? 'ğŸŸ¢' : corridorAnalysis.overall === 'RESTRICT' ? 'ğŸŸ¡' : 'ğŸ”´'} {corridorAnalysis.overall}
                                    </div>
                                    <div className="result-details">
                                        <span>ğŸ“ {corridorAnalysis.distance}m</span>
                                        <span>â±ï¸ {corridorAnalysis.time}ë¶„</span>
                                    </div>
                                </div>

                                <div className="segments-panel">
                                    <h3 className="text-white font-bold mb-3">ğŸ“Š êµ¬ê°„ë³„ ìœ„í—˜ë„</h3>
                                    {corridorAnalysis.segments.map(seg => (
                                        <div key={seg.id} className="segment-item" style={{
                                            borderColor: seg.status === 'GO' ? '#22c55e' : seg.status === 'RESTRICT' ? '#eab308' : '#ef4444'
                                        }}>
                                            <div className="flex justify-between text-sm font-bold text-white">
                                                <span>êµ¬ê°„ {seg.id}</span>
                                                <span style={{ color: seg.status === 'GO' ? '#22c55e' : seg.status === 'RESTRICT' ? '#eab308' : '#ef4444' }}>
                                                    {seg.status}
                                                </span>
                                            </div>
                                            <div className="text-xs text-gray-400 mt-1">
                                                ğŸ’¨ í’ì†: {seg.wind}m/s | ğŸ¢ ê±´ë¬¼: {seg.building}m
                                            </div>
                                        </div>
                                    ))}
                                </div>

                                <div className="settings-panel">
                                    <h3 className="text-white font-bold mb-3">ğŸ›¤ï¸ íšŒë‘ ì‹œê°í™”</h3>
                                    <div className="corridor-bar-container">
                                        {corridorAnalysis.segments.map(seg => (
                                            <div key={seg.id} className="bar-segment" style={{
                                                backgroundColor: seg.status === 'GO' ? '#22c55e' : seg.status === 'RESTRICT' ? '#eab308' : '#ef4444',
                                                width: `${100 / corridorAnalysis.segments.length}%`
                                            }} />
                                        ))}
                                    </div>
                                    <div className="bar-labels">
                                        <span>A ì¶œë°œ</span>
                                        <span>B ë„ì°©</span>
                                    </div>
                                </div>
                            </>
                        )}
                    </div>
                </div>
            )
        }
                </div >
            );
        }

        // React 18 createRoot
        const container = document.getElementById('root');
        const root = ReactDOM.createRoot(container);
        root.render(<App />);
    </script>
</body>

</html>